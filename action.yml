name: Deploy to Laravel Cloud
description: Trigger a Laravel Cloud deployment and optionally wait for it to finish.

inputs:
  api_token:
    description: Laravel Cloud API token (Bearer token from the Cloud UI).
    required: true
  application_name:
    description: Laravel Cloud application name (used to resolve the environment id).
    required: false
  environment_name:
    description: Laravel Cloud environment name (used to resolve the environment id).
    required: false
  environment:
    description: Laravel Cloud environment identifier (optional if using application_name + environment_name).
    required: false
  environment_id:
    description: Alias for environment id (optional if using application_name + environment_name).
    required: false
  no_wait:
    description: Do not wait for deployment to finish.
    required: false
    default: "false"
  poll_interval_seconds:
    description: Seconds between status checks when waiting.
    required: false
    default: "10"
  timeout_seconds:
    description: Maximum seconds to wait for deployment to finish.
    required: false
    default: "180"

outputs:
  deployment_id:
    description: The Laravel Cloud deployment id.
  deployment_status:
    description: The final deployment status when waiting, or initial status when not waiting.
  deployment_url:
    description: API URL for the deployment resource if provided by the API.
  environment_url:
    description: Environment URL (vanity domain if available, otherwise API link).
  success:
    description: '"true" when the deployment succeeds; otherwise "false".'

branding:
  icon: cloud
  color: blue

runs:
  using: composite
  steps:
    - name: Deploy to Laravel Cloud
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
        ACTION_REPO: ${{ github.action_repository }}
        LARAVEL_CLOUD_API_TOKEN: ${{ inputs.api_token }}
        LARAVEL_CLOUD_ENVIRONMENT: ${{ inputs.environment_id != '' && inputs.environment_id || inputs.environment }}
        LARAVEL_CLOUD_APPLICATION_NAME: ${{ inputs.application_name }}
        LARAVEL_CLOUD_ENVIRONMENT_NAME: ${{ inputs.environment_name }}
        LARAVEL_CLOUD_POLL_INTERVAL: ${{ inputs.poll_interval_seconds }}
        LARAVEL_CLOUD_TIMEOUT: ${{ inputs.timeout_seconds }}
      run: |
        echo "Select PHP Runtime..."
        case "${{ runner.os }}" in
          Linux)
            if [ "${{ runner.arch }}" = "ARM64" ]; then
              php_bin="${GITHUB_ACTION_PATH}/bin/php-linux-arm64"
            else
              php_bin="${GITHUB_ACTION_PATH}/bin/php-linux"
            fi
            ;;
          macOS)
            php_bin="${GITHUB_ACTION_PATH}/bin/php-macos"
            ;;
          *)
            echo "Unsupported runner OS: ${{ runner.os }}"
            exit 1
            ;;
        esac

        if [ ! -x "${php_bin}" ]; then
          echo "Missing static PHP binary at ${php_bin}"
          exit 1
        fi

        if [ -z "${ACTION_REPO}" ]; then
          ACTION_REPO="${GITHUB_REPOSITORY}"
        fi

        echo "Download PHAR..."
        release_json="$(curl -sSL \
          -H "Authorization: Bearer ${GITHUB_TOKEN}" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/${ACTION_REPO}/releases?per_page=50")"

        asset_url="$("${php_bin}" -r '
          $json = json_decode(stream_get_contents(STDIN), true);
          if (!is_array($json)) { exit(1); }
          foreach ($json as $release) {
            $tag = $release["tag_name"] ?? "";
            if (strpos($tag, "v1") !== 0) { continue; }
            foreach (($release["assets"] ?? []) as $asset) {
              if (($asset["name"] ?? "") === "laravel-cloud-deploy") {
                echo $asset["url"];
                exit(0);
              }
            }
          }
          exit(1);
        ' <<< "${release_json}")"

        if [ -z "${asset_url}" ]; then
          echo "Unable to locate a v1 release asset named laravel-cloud-deploy" >&2
          exit 1
        fi

        phar_path="${RUNNER_TEMP:-/tmp}/laravel-cloud-deploy"
        curl -sSL \
          -H "Authorization: Bearer ${GITHUB_TOKEN}" \
          -H "Accept: application/octet-stream" \
          "${asset_url}" \
          -o "${phar_path}"

        if [ ! -f "${phar_path}" ]; then
          echo "Failed to download PHAR to ${phar_path}" >&2
          exit 1
        fi

        echo "Deploy..."
        if [ "${{ inputs.no_wait }}" = "true" ]; then
          "${php_bin}" "${phar_path}" --no-wait
        else
          "${php_bin}" "${phar_path}"
        fi
